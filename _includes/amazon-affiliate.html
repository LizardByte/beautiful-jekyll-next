{% if site.data.amazon_products and site.data.amazon_products.size > 0 and
    site.amazon_products.enabled and
    site.amazon_products.affiliate_tag and
    page.amazon_products != false
%}
<div class="amazon-affiliate-container">
  <div class="affiliate-disclaimer">
    <small>
      <em>#CommissionsEarned | As an Amazon Associate we earn from qualifying purchases.</em>
    </small>
  </div>

  <div id="amazon-product-display">
    <!-- Product will be inserted here by JavaScript -->
  </div>
</div>

<script>
(function() {
  // Load products from Jekyll data
  const allProducts = {{ site.data.amazon_products | jsonify }};

  // Get affiliate tag from site config
  const affiliateTag = {{ site.amazon_products.affiliate_tag | jsonify }};

  // Get tags from page front matter if available
  const pageTags = {{ page.amazon_tags | default: page.tags | jsonify }};

  let filteredProducts = allProducts;

  // Filter products by tags if specified
  if (pageTags && pageTags.length > 0) {
    filteredProducts = allProducts.filter(product => {
      if (!product.tags) return false;
      // Check if any page tag matches any product tag
      return pageTags.some(pageTag =>
        product.tags.some(productTag =>
          productTag.toLowerCase() === pageTag.toLowerCase()
        )
      );
    });

    // If no products match, fall back to all products
    if (filteredProducts.length === 0) {
      filteredProducts = allProducts;
    }
  }

  let currentProductIndex = -1;

  function getRandomProduct() {
    if (filteredProducts.length === 0) return null;

    // Get a random index different from the current one if possible
    let newIndex;
    if (filteredProducts.length > 1) {
      do {
        newIndex = Math.floor(Math.random() * filteredProducts.length);
      } while (newIndex === currentProductIndex);
    } else {
      newIndex = 0;
    }

    currentProductIndex = newIndex;
    return filteredProducts[newIndex];
  }

  function addAffiliateTag(url) {
    if (!affiliateTag || !url) return url;

    try {
      const urlObj = new URL(url);
      urlObj.searchParams.set('tag', affiliateTag);
      return urlObj.toString();
    } catch (e) {
      console.error('Invalid URL:', url);
      return url;
    }
  }

  function displayProduct(product) {
    if (!product) return;

    const container = document.getElementById('amazon-product-display');
    if (!container) return;

    // Add affiliate tag to product link
    const productLink = addAffiliateTag(product.link);

    container.innerHTML = `
      <div class="amazon-product-display">
        <div class="product-image">
          <a href="${productLink}" target="_blank" rel="noopener noreferrer nofollow sponsored">
            <img src="${product.image}" alt="${product.title}">
          </a>
        </div>
        <div class="product-details">
          <h4>
            <a href="${productLink}" target="_blank" rel="noopener noreferrer nofollow sponsored">
              ${product.title}
            </a>
          </h4>
          <a href="${productLink}" target="_blank" rel="noopener noreferrer nofollow sponsored" class="product-link">
            View on Amazon
          </a>
          ${product.tags ? `
            <div class="product-tags">
              <small>
                ${product.tags.map(tag => `<span class="product-tag">${tag}</span>`).join('')}
              </small>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }

  // Display initial random product
  displayProduct(getRandomProduct());

  // Rotate product every 30 seconds
  setInterval(function() {
    displayProduct(getRandomProduct());
  }, 30000); // 30 seconds
})();
</script>
{% endif %}
